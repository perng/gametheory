<!DOCTYPE html>
<html>
   <head>
      <title>Websocket Chatroom</title>
      <script type="text/javascript">
         var socket = null;
         var isopen = false;
         var current_cmd = '';  // keep track of current status.
         var current_tid = '';  // keep track of current tracker id.
         function doDisconnect(startup) {
             if (socket != null) socket.close();
             socket = null;
             isopen = false;
             //if (! startup) appendChatroom("<font color='green'>Disconnected!</font>");
             if (! startup) dispConnectionStatus("<font color='green'>Disconnected!</font>")
             toggleButton(true);
             updateInfo('');
         }
         function dispConnectionStatus(msg) {
             document.getElementById('connection_status').innerHTML = msg;
             //updateInfo(msg);
         }
         function btnConnect_onclick(b) {
             if (b.value == 'Connect') {
                 b.disabled = true;
                 doConnect();
             } else {
                 doDisconnect(false);
             }
         }
         function doConnect() {
         //window.onload = function() {
            document.getElementById('btnConnect').disabled = true;
            //appendChatroom("<font color='orange'>connecting ...</font>");
            dispConnectionStatus("<font color='orange'>Connecting ...</font>")
            var ws = "ws://" + document.getElementById('ws').value;
            socket = new WebSocket(ws); 
            socket.binaryType = "arraybuffer";
            socket.onopen = function() {
               //console.log("Connected!");
               isopen = true;
               //appendChatroom("<font color='green'>Connected!</font>");
               dispConnectionStatus("<font color='green'>Connected!</font>");
               updateInfo('');
               toggleButton(false);
            }
            socket.onerror = function() {
                //appendChatroom("<font color='red'>Connection not opened.</font>");
                dispConnectionStatus("<font color='red'>Connection not opened.</font>")
                document.getElementById('btnConnect').disabled = false;
                updateInfo("<font color='red'>Cannot open connection.</font>");
            }
            socket.onmessage = function(e) {
               if (typeof e.data == "string") {
                  //console.log("Text message received: " + e.data);
                  appendChatroom("Text message received: " + e.data);
                  process_message(e.data);
               } else {
                  var arr = new Uint8Array(e.data);
                  //console.log("Binary message received: " + hex);
                  appendChatroom("Binary message received: " + decodeBinaryMsg(arr));
               }
            }
            socket.onclose = function(e) {
               //console.log("Connection closed.");
               //appendChatroot("<font color='green'>Connection closed.</font>");
               dispConnectionStatus("<font color='green'>Connection is closed.</font>")
               socket = null;
               isopen = false;
            }
         };
         function decodeBinaryMsg(arr) {
              var hex = '';
              for (var i = 0; i < arr.length; i++) {
                  hex += ('00' + arr[i].toString(16)).substr(-2);
              }
              return hex;
         }
         function toggleButton(v) {
            document.getElementById('btnConnect').disabled = false;
            document.getElementById('btnConnect').value = v ? 'Connect' : 'Disconnect';
            document.getElementById('btnSendTxt').disabled = v;
            document.getElementById('txtMsg').disabled = v;
            document.getElementById('txtMsg').focus();
            //document.getElementById('btnSendBin').disabled = v;
            document.getElementById('ws').disabled = ! v;
            document.getElementById('span_action').style.display = v ? 'none' : 'block';
         }
         function sendText() {
            if (isopen) {
               var msg = "Hello, world!";
               var o = document.getElementById('txtMsg');
               if (o.value.trim() == '') { getInputFocus(); return; }

               if (o && o.value != '') {
                   msg = o.value;
                   o.value = '';
               }
               socket.send(msg);
               //console.log("Text message sent: " + msg);
               appendChatroom("me>>> " + msg);
            } else {
               //console.log("Connection not opened.")
               appendChatroom("<font color='red'>Connection not opened.</font>");
            }
         };
         // http://stackoverflow.com/questions/14430633/how-to-convert-text-to-binary-code-in-javascript
         function sendBinary() {
            if (isopen) {
               var o = document.getElementById('txtMsg');
               var v = o.value;
               if (v.trim() == '') { getInputFocus(); return; }

               if (v.length == 0) {
                   var buf = new ArrayBuffer(32);
                   var arr = new Uint8Array(buf);
                   for (i = 0; i < arr.length; ++i) arr[i] = i;
               } else {
                   var buf = new ArrayBuffer(v.length);
                   var arr = new Uint8Array(buf);
                   for (i = 0; i < arr.length; ++i) {
                       arr[i] = v[i].charCodeAt(0); //.toString(2);
                   }
               }

               socket.send(buf);
               //console.log("Binary message sent.");
               appendChatroom("Binary message sent: " + decodeBinaryMsg(arr));
               o.value = '';
            } else {
               //console.log("Connection not opened.")
               appendChatroom("<font color='red'>Connection not opened.</font>");
            }
         };
         function appendChatroom(msg) {
             var c = document.getElementById('chatroom');
             if (c) { c.innerHTML += msg + '<br/>'; }
             updateScroll();
             getInputFocus();
         }
         function checkEnter(e) {
             // look for window.event in case event isn't passed in
             e = e || window.event;
             if (e.keyCode == 13) { sendText(); }
         }
         function getInputFocus() {
             document.getElementById('txtMsg').focus();
         }
         /* Scroll down to always show most recent message at bottom. */
         function updateScroll() {
             var e = document.getElementById("chatroom");
             e.scrollTop = e.scrollHeight;
         }
         function clearChatroom() {
             document.getElementById("chatroom").innerHTML = '';
         }
         function selectText(containerid) {
             if (document.selection) {
                 var range = document.body.createTextRange();
                 range.moveToElementText(document.getElementById(containerid));
                 range.select();
              } else if (window.getSelection) {
                  var range = document.createRange();
                  range.selectNode(document.getElementById(containerid));
                  window.getSelection().addRange(range);
              }
         }
         function updateInfo(msg) {
             document.getElementById('div_info').innerHTML = msg;
             //document.getElementById('connection_status').innerHTML = msg;
         }

         function showFormReg() {
             document.getElementById('form_reg').style.display='block';
             document.getElementById('form_login').style.display='none';
             document.getElementById('reg_name').focus();
         }
         function cancelFormReg() {
             document.getElementById('form_reg').style.display='none';
             document.getElementById('form_login').style.display='block';
             document.getElementById('login_name').focus();
         }
         function doRegister() {
             var usr = document.getElementById('reg_name').value.trim();
             var pwd = document.getElementById('reg_pwd').value.trim();
             if (usr == '' || pwd == '') {
                 updateInfo('<font color="red">Register failed: name and password cannot be empty.</font>');
                 document.getElementById('reg_name').focus();
                 return;
             }
             current_tid = make_tracker();
             var msg = '{"cmd":"register","usr":"' + usr + '","pwd":"' + pwd + '","tracker":"' + current_tid + '"}';
             //alert(msg);
             current_cmd = 'register';
             socket.send(msg);
         }
         function doLogin() {
             var usr = document.getElementById('login_name').value;
             var pwd = document.getElementById('login_pwd').value;
             current_tid = make_tracker();
             var msg = '{"cmd":"login","type":"reg","usr":"' + usr + '","pwd":"' + 
                        pwd + '","tracker":"' + current_tid + '"}';
             //alert(msg);
             current_cmd = 'login';
             socket.send(msg);
         }
         function doLogout() {
             if (! confirm('Are you sure to log out?')) return;
             var msg = '{"cmd":"logout"}';
             socket.send(msg);
         }

         function process_message(msg) {
             //alert(msg);
             var jo = JSON.parse(msg);
             var cmd = jo.cmd;
             //alert(jo + ',' + cmd);
             if (cmd == 'c_response') handle_c_response(jo);
             else if (cmd == 'c_speak') handle_c_speak(jo);
             else if (cmd == 'c_whisper') handle_c_whisper(jo);
             else if (cmd == 'c_broadcast') handle_c_broadcast(jo);
             else if (cmd == 'c_invited') handle_c_invited(jo);
             else if (cmd == 'c_event') handle_c_event(jo);
         }

         function handle_c_response(jo) {
             var status = jo.status;
             var last_cmd = jo.last_cmd;
             var msg = jo.msg;
             var tracker = jo.tracker;
             dump(':response: ' + status + ', ' + last_cmd + ', ' + msg + ',' + tracker);
             if (last_cmd == 'register')         { handle_cr_register(status, msg, tracker); }
             else if (last_cmd == 'login')       { handle_cr_login(status, msg, tracker); }
             else if (last_cmd == 'update_pwd')  { handle_cr_update_pwd(status, msg, tracker); }
             else if (last_cmd == 'create_room') { handle_cr_create_room(status, msg, tracker); }
             else if (last_cmd == 'invite')      { handle_cr_invite(status, msg, tracker); }
             else if (last_cmd == 'join_room')   { handle_cr_join_room(status, msg, tracker); }
             else if (last_cmd == 'leave_room')  { handle_cr_leave_room(status, msg, tracker); }
             else if (last_cmd == 'speak')       { handle_cr_speak(status, msg, tracker); }
             else if (last_cmd == 'whisper')     { handle_cr_whisper(status, msg, tracker); }
             else if (last_cmd == 'broadcast')   { handle_cr_broadcast(status, msg, tracker); }
             else if (last_cmd == 'admin_show_table') { handle_cr_admin_show_table(status, msg, tracker); }
             else if (last_cmd == 'logout')      { handle_cr_logout(status, msg, tracker); }
         }
         function handle_c_speak(jo) {
             var msg = jo.msg;
             var usr = jo.usr;
             var room_name = jo.room_name;
             var tracker = jo.tracker;
             dump(':speak: ' + msg + ',' + room_name + ',' + tracker);
         }
         function handle_c_whisper(jo) {
             var msg = jo.msg;
             var usr = jo.usr;
             var tracker = jo.tracker;
             dump(':whisper: ' + msg + ',' + usr + ',' + tracker);
         }
         function handle_c_broadcast(jo) {
             var msg = jo.msg;
             var usr = jo.usr;
             var tracker = jo.tracker;
             dump(':boradcast: ' + msg + ',' + usr + ',' + tracker);
         }
         function handle_c_invited(jo) {
             var msg = jo.msg;
             var usr = jo.usr;
             var room_name = jo.room_name;
             var tracker = jo.tracker;
             dump(':invited: ' + msg + ',' + usr + ',' + room_name + ',' + tracker);
         }
         function handle_c_event(jo) {
             var type = jo.type;
             var usr = jo.usr;
             var tracker = jo.tracker;
             dump(':event: ' + type + ',' + usr + ',' + tracker);
         }
         function dump(msg) {
             appendChatroom(msg);
         }

         function make_tracker() {
             // create a random number as tracker.
             return Math.floor((Math.random() * 1000000) + 1);
         }

         /* handle response messages. */
         function handle_cr_register(status, msg, tracker) {
             if (current_cmd != "register" || current_tid != tracker) {
                 dump('false register response. abort');
                 dump('cur_cmd = ' + current_cmd + ', cur_tid = ' + current_tid);
                 return;
             }
             if (status == 'ok') {
                 //document.getElementById('span_action').style.display = 'none';
                 document.getElementById('reg_pwd').value = ''; // clear password.
                 updateInfo("<font color='green'>You are registered. Now you can log in.");
                 cancelFormReg();
             } else {
                 updateInfo('<font color="red">Register failed: ' + msg + '.</font>');
                 document.getElementById('reg_name').focus();
             }
         }
         function handle_cr_login(status, msg, tracker) {
             //alert('get in. status = ' + status);
             if (current_cmd != "login" || current_tid != tracker) {
                 dump('false login response. abort.');
                 //dump('cur_cmd = ' + current_cmd + ', cur_tid = ' + current_tid);
                 return;
             }
             if (status == 'ok') {
                 document.getElementById('span_action').style.display = 'none';
                 document.getElementById('login_pwd').value = ''; // clear password.
                 updateInfo("<font color='green'>You are logged in. <a href='#' onclick='doLogout();'>Log out</a></font>");
             } else {
                 updateInfo('<font color="red">Invalid login name or password.</font>');
                 document.getElementById('login_name').focus();
             }
         }
         function handle_cr_update_pwd(status, msg, tracker) {

         }
         function handle_cr_create_room(status, msg, tracker) {

         }
         function handle_cr_invite(status, msg, tracker) {

         }
         function handle_cr_join_room(status, msg, tracker) {

         }
         function handle_cr_leave_room(status, msg, tracker) {

         }
         function handle_cr_speak(status, msg, tracker) {

         }
         function handle_cr_whisper(status, msg, tracker) {

         }
         function handle_cr_broadcast(status, msg, tracker) {

         }
         function handle_cr_admin_show_table(status, msg, tracker) {

         }
         function handle_cr_logout(status, msg, tracker) {
             if (status == 'ok') {
                 updateInfo('<font color="orange">You are logged out.</font>');
                 document.getElementById('span_action').style.display = 'block';
             }
             else {
                 updateInfo(msg);
             }
         }
      </script>

      <style type="text/css">
      #chatroom {
        height: 300px;
        width: 720px;
        background-color: #eeeeff;
        overflow:auto;
        overflow-y: scroll;
        position: relative;
        bottom: 0;
      }
      </style>
   </head>
   <body onload="doDisconnect(true);">
      <h1>Websocket Chatroom</h1>

      Server: ws://<input type="text" id="ws" value="127.0.0.1:9000"/>
      <input type='button' id='btnConnect' onclick='btnConnect_onclick(this);' value='Connect'></input>
      <span id='connection_status'></span>&nbsp;&nbsp;<span id="div_info"></span>
      <br/><br/>

      <span id='span_action' style='display:none;'>
      <span id='form_reg' style='display:none;'>
      name: <input type='txt' id='reg_name'/>
      password: <input type='password' id='reg_pwd'/>
      <input type='button' value='Register' onclick='doRegister();'></input>
      &nbsp;&nbsp;<a href='#' onclick="cancelFormReg();">Cancel</a>
      <br/><br/>
      </span>

      <span id='form_login' style='display:inline-block;'>
      name: <input type='txt' id='login_name'/>
      password: <input type='password' id='login_pwd'/>
      <input type='button' value='Login' onclick='doLogin();'></input>
      &nbsp;&nbsp;<a href='#' onclick="showFormReg();">Register</a>
      <br/><br/>
      </span>
      </span>
      <!--div id='div_info'></div-->

      <input type="text" id="txtMsg" onkeypress="checkEnter(event);" size="50"/>
      <button id='btnSendTxt' onclick='sendText();'>Send Text Message</button>
      <button style='display:none;' id='btnSendBin' onclick='sendBinary();'>Send Binary Message</button>
      <button onclick='clearChatroom();'>Clear Chat History</button>
      <button onclick="selectText('chatroom');">Select/Copy Chat History</button>

      <br/><br/>

      <div id="chatroom" ></div>

      <script type="text/javascript">
      getInputFocus();
      </script>
   </body>
</html>
