<!DOCTYPE html>
<html>
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
      <meta name="description" content="Chatroom">
      <meta name="keywords" content="websocket chatroom, websocket, chatroom">
      <script type="text/javascript" src="js/ajax/libs/jquery/1.4/jquery.min.js"></script>
      <title>Websocket Chatroom</title>
      <script type="text/javascript">
         var socket = null;
         var isopen = false;
         var current_cmd = '';  // keep track of current status.
         var current_tid = '';  // keep track of current tracker id.
         var current_user = ''; // keep track of current logged in user.
         var current_room = ''; // keep track of current room.
         var request_src = ''; // used for command line requests @rooms, @users.

         // If this is not empty, the server textbox and connect button will
         // be hidden, and when the page is loaded it'll automatically connect to 
         // server given by the value of AUTO_CONNECT.
         var AUTO_CONNECT = ''; 
         //AUTO_CONNECT = 'ws://127.0.0.1:9000';
         AUTO_CONNECT = 'ws://192.168.198.131:9000';

         // If DEBUG is true, the debug console will be shown.
         var DEBUG = true;
         //DEBUG = false;

         function send_data(data) {
             appendConsole('==> Send: ' + data);
             socket.send(data);
         }

         function doDisconnect(startup) {
             if (! startup && ! confirm('Are you sure to disconnect?')) return;

             if (socket != null) socket.close();
             socket = null;
             isopen = false;
             //if (! startup) appendConsole("<font color='green'>Disconnected!</font>");
             if (! startup) dispConnectionStatus("<font color='green'>Disconnected!</font>")
             toggleButton(true);
             cleanup_logout();
         }
         function dispConnectionStatus(msg) {
             document.getElementById('connection_status').innerHTML = msg;
             //updateInfo(msg);
         }
         function btnConnect_onclick(b) {
             if (b.value == 'Connect') {
                 b.disabled = true;
                 current_cmd = 'doConnect';
                 doConnect();
             } else {
                 doDisconnect(false);
                 setTimeout(function() { 
                     dispConnectionStatus("<font color='green'>Connection is closed.</font>"); 
                 }, 10);
             }
         }
         function doConnect() {
         //window.onload = function() {
            cleanup_logout(); // clean up before start.

            document.getElementById('btnConnect').disabled = true;
            //appendConsole("<font color='orange'>connecting ...</font>");
            dispConnectionStatus("<font color='orange'>Connecting ...</font>")
            var ws = "ws://" + document.getElementById('ws').value;
            if (AUTO_CONNECT != '') ws = AUTO_CONNECT;

            socket = new WebSocket(ws); 
            socket.binaryType = "arraybuffer";
            socket.onopen = function() {
               //console.log("Connected!");
               isopen = true;
               current_cmd = '';

               if (AUTO_CONNECT != '') {
                   dispConnectionStatus("Welcome to chatroom.");
               } else {
                   //dispConnectionStatus("<font color='green'>Connected!</font>");
                   dispConnectionStatus('');
               }

               updateInfo('');
               toggleButton(false);
            }
            socket.onerror = function() {
                //appendConsole("<font color='red'>Connection not opened.</font>");
                dispConnectionStatus("<font color='red'>Connection not opened.</font>")
                document.getElementById('btnConnect').disabled = false;
                //updateInfo("Cannot open connection.", 'error');
            }
            socket.onmessage = function(e) {
               if (typeof e.data == "string") {
                  //console.log("Text message received: " + e.data);
                  appendConsole("Text message received: " + e.data);
                  process_message(e.data);
               } else {
                  var arr = new Uint8Array(e.data);
                  //console.log("Binary message received: " + hex);
                  appendConsole("Binary message received: " + decodeBinaryMsg(arr));
               }
            }
            socket.onclose = function(e) {
               //console.log("Connection closed.");
               //appendChatroot("<font color='green'>Connection closed.</font>");
               dispConnectionStatus("<font color='green'>Connection is closed.</font>")
               socket = null;
               isopen = false;

               if (current_cmd == 'doConnect') {
                   dispConnectionStatus("<font color='red'>Server is not available.</font>");
               } else {
                   handle_cr_logout('ok', 'connection reset by server', '0');
                   toggleButton(true);
                   cleanup_logout();
                   dispConnectionStatus("<font color='red'>Connection reset by server.</font>");
               }
            }
         };
         function decodeBinaryMsg(arr) {
              var hex = '';
              for (var i = 0; i < arr.length; i++) {
                  hex += ('00' + arr[i].toString(16)).substr(-2);
              }
              return hex;
         }
         function toggleButton(v) {
            document.getElementById('btnConnect').disabled = false;
            document.getElementById('btnConnect').value = v ? 'Connect' : 'Disconnect';
            document.getElementById('ws').disabled = ! v;
            document.getElementById('span_action').style.display = v ? 'none' : 'block';
         }
         function disableChatroom(v) {
            document.getElementById('btnSendTxt').disabled = v;
            document.getElementById('txtMsg').disabled = v;
            if (v) document.getElementById('txtMsg').focus();
            //document.getElementById('btnSendBin').disabled = v;
         }
         function sendText() {
            if (isopen) {
               var msg = "Hello, world!";
               var o = document.getElementById('txtMsg');
               if (o.value.trim() == '') { getInputFocus(); return; }

               if (o && o.value != '') {
                   msg = o.value;
                   o.value = '';
               }

               current_tid = make_tracker();

               if (msg == '@rooms') {
                   request_src = 'console';
                   current_cmd = "get_room_list";
                   data = '{"cmd":"get_room_list", "tracker":"' + current_tid + '"}';
                   send_data(data);
                   //appendChatroomInfo(msg + ":");
               }
               else if (msg == '@users') {
                   request_src = "console"
                   current_cmd = "get_user_list";
                   data = '{"cmd":"get_user_list", "tracker":"' + current_tid + '"}';
                   send_data(data);
                   //appendChatroomInfo(msg + ":");
               }
               else if (msg == '@help') {
                   appendChatroomInfo(msg + 
": @rooms (list rooms), @who (list room users), @users (list logged in users), @create {room} (create and join a room), @join {room} (join a room), @leave (leave a room), @where (show current name), @passwd {new password} (update password)");
               }
               else if (msg == '@leave') {
                   doLeaveRoom();
               }
               else if (msg == '@create') {
                   appendChatroomInfo('@create: please provide a room name');
               }
               else if (msg.startsWith('@create ')) {
                   request_src = "console";
                   var room_name = msg.substr(8); // after '@create '
                   if (room_name == '') {
                       appendChatroomInfo('@create: please provide a room name');
                   }
                   appendConsole('Now create room: ' + room_name);
                   doCreateRoom(room_name);
               }
               else if (msg == '@join') {
                   appendChatroomInfo('@create: please provide a room name');
               }
               else if (msg.startsWith('@join ')) {
                   var room_name = msg.substr(6); // after '@join '
                   if (room_name == '') {
                       appendChatroomInfo('@create: please provide a room name');
                   }
                   appendConsole('Now join room: ' + room_name);
                   doJoinRoom(room_name);
               }
               else if (msg.startsWith('@passwd ')) {
                   var pwd = msg.substr(8);
                   if (pwd == '' || pwd.length < 8) {
                       appendChatroomInfo('@passwd: password must be at least 8 characters in length');
                   }
                   else {
                       doUpdatePwd2(pwd);
                       appendChatroomInfo('@passwd: changing password ..');
                   }
               }
               // All commands below need a non-empty current_room.
               else if (current_room == '') {
                   //appendChatroomInfo('>> ' + msg);
                   appendChatroomInfo('You are not in a room, text is not sent: ' + msg);
                   appendChatroomInfo('Type @rooms for room list, @create {room} to create room, @join {room} to join a room, @help for more.');
                   appendConsole('Type message before join a room:' + msg);
               }
               else if (msg == '@who') {
                   request_src = "console_who";
                   current_cmd = "get_room_user_list";
                   data = '{"cmd":"get_room_user_list", "room_name":"' + current_room + '", "tracker":"' + current_tid + '"}';
                   send_data(data);
                   //appendChatroomInfo(msg + ":");
               }
               else if (msg == '@where') {
                   appendChatroomInfo('@where: you are in room: ' + current_room);
               }
               else if (msg == '@invite') {
                   appendChatroomInfo('@create: please provide a user name');
               }
               else if (msg.startsWith('@invite ')) {
                   var user_name = $.trim( msg.substr(8) ); // after '@invite '
                   if (user_name == '') {
                       appendChatroomInfo('@create: please provide a user name');
                   }
                   appendConsole('Now invite: ' + user_name);
                   doInvite(user_name);
               }
               else {
                   current_cmd = "speak";
                   //alert(msg);
                   data = '{"cmd":"speak", "room_name":"' + current_room + '", "msg":"' + strEncode(msg) + 
                          '", "tracker":"' + current_tid + '"}';
                   send_data(data);
                   //console.log("Text message sent: " + msg);
                   appendChatroom('<font color="#99ff99">>> ' + msg + '</font>');
               }
            } else {
               //console.log("Connection not opened.")
               appendChatroom("<font color='red'>Connection not opened.</font>");
            }
         }


         // double quote need be encoded.
         function strEncode(s) {
             s = s.replace(/&/g, "&amp;");
             return s.replace(/"/g, '&quot;');
         }
         function strDecode(s) {
             s = s.replace(/&quot;/g, '"');
             return s.replace(/&amp;/g, '&');
         }

         // http://stackoverflow.com/questions/14430633/how-to-convert-text-to-binary-code-in-javascript
         function sendBinary() {
            if (isopen) {
               var o = document.getElementById('txtMsg');
               var v = o.value;
               if (v.trim() == '') { getInputFocus(); return; }

               if (v.length == 0) {
                   var buf = new ArrayBuffer(32);
                   var arr = new Uint8Array(buf);
                   for (i = 0; i < arr.length; ++i) arr[i] = i;
               } else {
                   var buf = new ArrayBuffer(v.length);
                   var arr = new Uint8Array(buf);
                   for (i = 0; i < arr.length; ++i) {
                       arr[i] = v[i].charCodeAt(0); //.toString(2);
                   }
               }

               send_data(buf);
               //console.log("Binary message sent.");
               appendConsole("Binary message sent: " + decodeBinaryMsg(arr));
               o.value = '';
            } else {
               //console.log("Connection not opened.")
               appendConsole("<font color='red'>Connection not opened.</font>");
            }
         };
         function appendConsole(msg) {
             var c = document.getElementById('console');
             if (c) { c.innerHTML += msg + '<br/>'; }
             updateScroll(c);
             getInputFocus();
         }
         function appendChatroom(msg) {
             var c = document.getElementById('chatroom');
             if (c) { c.innerHTML += msg + '<br/>'; }
             updateScroll(c);
             getInputFocus();
         }
         function appendChatroomInfo(msg) {
             appendChatroom('<font color="orange">' + msg + '</font>');
         }
         function checkEnter(e) {
             // look for window.event in case event isn't passed in
             e = e || window.event;
             if (e.keyCode == 13) { sendText(); }
         }
         function getInputFocus() {
             document.getElementById('txtMsg').focus();
         }
         /* Scroll down to always show most recent message at bottom. */
         function updateScroll(e) {
             //var e = document.getElementById("chatroom");
             e.scrollTop = e.scrollHeight;
         }
         function clearChatroom() {
             document.getElementById("chatroom").innerHTML = '';
         }
         function selectText(containerid) {
             if (document.selection) {
                 var range = document.body.createTextRange();
                 range.moveToElementText(document.getElementById(containerid));
                 range.select();
              } else if (window.getSelection) {
                  var range = document.createRange();
                  range.selectNode(document.getElementById(containerid));
                  window.getSelection().addRange(range);
              }
         }
         function updateInfo(msg, type) {
             if (msg == '') {
                 document.getElementById('div_info').innerHTML = '';
                 return;
             }

             type = (typeof type === 'undefined') ? 'ok' : type;

             if (type == 'ok') {
                 msg = '<font color="green">' + msg + '</font>';
             } 
             else if (type == 'info') {
                 msg = '<font color="orange">' + msg + '</font>';
             }
             else if (type == 'error') {
                 msg = '<font color="red">' + msg + '</font>';
             }

             document.getElementById('div_info').innerHTML = msg;
             //document.getElementById('connection_status').innerHTML = msg;
         }
         function ucFirst(s) {
             if (s.length == 0) return '';
             return s.substr(0,1).toUpperCase() + s.substr(1);
         }

         function showFormReg() {
             document.getElementById('form_reg').style.display='block';
             document.getElementById('form_login').style.display='none';
             document.getElementById('reg_name').focus();
         }
         function cancelFormReg() {
             document.getElementById('form_reg').style.display='none';
             document.getElementById('form_login').style.display='block';
             document.getElementById('login_name').focus();
             $('#div_info').html('');
         }
         function doRegister() {
             var usr = document.getElementById('reg_name').value.trim();
             var pwd = document.getElementById('reg_pwd').value.trim();
             if (usr == '' || pwd == '') {
                 updateInfo('Register failed: name and password cannot be empty.', 'error');
                 document.getElementById('reg_name').focus();
                 return;
             }
             current_tid = make_tracker();
             var msg = '{"cmd":"register","usr":"' + usr + '","pwd":"' + pwd + '","tracker":"' + current_tid + '"}';
             //alert(msg);
             current_cmd = 'register';
             send_data(msg);
         }
         function doLogin() {
             var usr = document.getElementById('login_name').value;
             var pwd = document.getElementById('login_pwd').value;
             current_tid = make_tracker();
             var msg = '{"cmd":"login","type":"reg","usr":"' + usr + '","pwd":"' + 
                        pwd + '","tracker":"' + current_tid + '"}';
             //alert(msg);
             current_cmd = 'login';
             send_data(msg);
         }
         function doLogout() {
             if (! confirm('Are you sure to log out?')) return;

             // should logout locally no matter what happen on server side.
             // if disconnected before sending logout msg, will not get any
             // response anyways. So do UI logout display here.
             //$('#div_logout').html('');
             //updateInfo('You are logging out.', 'info');
             //document.getElementById('span_action').style.display = 'block';
             //cleanup_logout();

             var msg = '{"cmd":"logout"}';
             send_data(msg);
         }
         function doCreateRoom(room) {
             current_tid = make_tracker();
             var room_name = $.trim(room);
             if (room_name == '') {
                 updateInfo("Please enter a room name.", 'error');
                 if (request_src != 'concole') $('#txtNewRoom').focus();
                 return;
             }
             var msg = '{"cmd":"create_room","room_name":"' + room_name + 
                       '", "tracker":"' + current_tid + '"}';
             send_data(msg);
         }
         function doLeaveRoom() {
             if (current_room == '') {
                 appendChatroomInfo('@leave You are not in any room yet.');
                 return;
             }

             current_tid = make_tracker();
             current_cmd = "leave_room";
             var msg = '{"cmd":"leave_room", "room_name":"' + current_room +
                       '", "tracker":"' + current_tid + '"}';
             send_data(msg);
         }
         function doUpdatePwd2(pwd) {
             current_tid = make_tracker();
             current_cmd = "update_pwd2";
             var msg = '{"cmd":"update_pwd2", "pwd":"' + pwd +
                       '", "tracker":"' + current_tid + '"}';
             send_data(msg);
         }
         function doJoinRoom(room) {
             var room_name = $.trim(room);
             if (room_name == '') {
                 updateInfo('Please select a room to join', 'error');
                 return;
             }
             current_tid = make_tracker();
             current_cmd = "join_room";
             var msg = '{"cmd":"join_room", "room_name":"' + room_name + 
                       '", "tracker":"' + current_tid + '"}';
             send_data(msg);
         }
         function doInvite(user) {
             var user_name = $.trim(user);

             current_tid = make_tracker();
             current_cmd = "invite";
             var msg = '{"cmd":"invite", "room_name":"' + current_room +
                       '", "invitee":"' + user_name +
                       '", "tracker":"' + current_tid + '"}';
             send_data(msg);
         }
         function doInviteReply(e, v) {
             // continue only when Enter is pressed.
             e = e || window.event;
             if (e.keyCode != 13) { return; }

             v = v.toLowerCase();

             var reply = '';
             if (v == 'yes' || v == 'y') { reply = 'Y'; }
             else if (v == 'no' || v == 'n') { reply = 'N'; }
             else if (v == 'later' || v == 'l') { reply = 'L'; }

             if (reply != '') {
                 current_tid = make_tracker();
                 var inviter = $('#inviter').val();
                 var inviter_room = $('#inviter_room').val();
                 var msg = '{"cmd":"invite_reply", "inviter":"' + inviter +
                   '", "room_name":"' + inviter_room + 
                   '", "reply":"' + reply + '", "tracker":"' + current_tid + '"}';
                 send_data(msg);

                 $('#span_invite').hide();
                 $('#txtMsg').removeAttr('disabled');
                 $('#txtMsg').focus();
             }
         }

         function process_message(msg) {
             //alert(msg);
             var jo = JSON.parse(msg);
             var cmd = jo.cmd;
             //alert(jo + ',' + cmd);
             if (cmd == 'c_response') handle_c_response(jo);
             else if (cmd == 'c_speak') handle_c_speak(jo);
             else if (cmd == 'c_whisper') handle_c_whisper(jo);
             else if (cmd == 'c_broadcast') handle_c_broadcast(jo);
             else if (cmd == 'c_invited') handle_c_invited(jo);
             else if (cmd == 'c_invite_reply') handle_c_invite_reply(jo);
             else if (cmd == 'c_event') handle_c_event(jo);
         }

         function handle_c_response(jo) {
             var status = jo.status;
             var last_cmd = jo.last_cmd;
             var msg = jo.msg;
             var tracker = jo.tracker;
             //dump(':response: ' + status + ', ' + last_cmd + ', ' + msg + ',' + tracker);

             if (status == 'ok') { updateInfo(''); }

             if (last_cmd == 'register')         { handle_cr_register(status, msg, tracker); }
             else if (last_cmd == 'login')       { handle_cr_login(status, msg, tracker); }
             else if (last_cmd == 'update_pwd')  { handle_cr_update_pwd(status, msg, tracker); }
             else if (last_cmd == 'update_pwd2')  { handle_cr_update_pwd2(status, msg, tracker); }
             else if (last_cmd == 'get_room_list')  { handle_cr_get_room_list(status, msg, tracker); }
             else if (last_cmd == 'get_user_list')  { handle_cr_get_user_list(status, msg, tracker); }
             else if (last_cmd == 'get_room_user_list')  { handle_cr_get_room_user_list(status, msg, tracker); }
             else if (last_cmd == 'create_room') { handle_cr_create_room(status, msg, tracker); }
             else if (last_cmd == 'invite')      { handle_cr_invite(status, msg, tracker); }
             else if (last_cmd == 'invite_reply')      { handle_cr_invite_reply(status, msg, tracker); }
             else if (last_cmd == 'join_room')   { handle_cr_join_room(status, msg, tracker); }
             else if (last_cmd == 'leave_room')  { handle_cr_leave_room(status, msg, tracker); }
             else if (last_cmd == 'speak')       { handle_cr_speak(status, msg, tracker); }
             else if (last_cmd == 'whisper')     { handle_cr_whisper(status, msg, tracker); }
             else if (last_cmd == 'broadcast')   { handle_cr_broadcast(status, msg, tracker); }
             else if (last_cmd == 'admin_show_table') { handle_cr_admin_show_table(status, msg, tracker); }
             else if (last_cmd == 'logout')      { handle_cr_logout(status, msg, tracker); }
         }
         function handle_c_speak(jo) {
             var msg = jo.msg;
             var usr = jo.usr;
             var room_name = jo.room_name;
             var tracker = jo.tracker;
             //dump(':speak: ' + msg + ',' + room_name + ',' + tracker);
             msg = strDecode(msg);
             appendChatroom('>> ' + usr + ': ' + msg);
         }
         function handle_c_whisper(jo) {
             var msg = jo.msg;
             var usr = jo.usr;
             var tracker = jo.tracker;
             dump(':whisper: ' + msg + ',' + usr + ',' + tracker);
         }
         function handle_c_broadcast(jo) {
             var msg = jo.msg;
             var usr = jo.usr;
             var tracker = jo.tracker;
             dump(':boradcast: ' + msg + ',' + usr + ',' + tracker);
         }
         function handle_c_invited(jo) {
             var msg = jo.msg;
             var usr = jo.usr;
             var room_name = jo.room_name;
             var tracker = jo.tracker;
             dump(':invited: ' + msg + ',' + usr + ',' + room_name + ',' + tracker);

             // disable message box, enable after reply to invitatio request.
             $('#txtMsg').attr('disabled', 'disabled');

             $('#inviter').val(usr);
             $('#inviter_room').val(room_name);
             $('#invite_msg').html(usr + ' invited you to join room ' +
                                   room_name + ' (yes/no/later)?');
             $('#span_invite').show();
             $('#txtInviteReply').focus();
         }
         function handle_c_invite_reply(jo) {
             var msg = jo.msg;
             var usr = jo.usr;
             var tracker = jo.tracker;
             dump(':invited: ' + msg + ',' + usr + ',' + tracker);

             if (msg == 'Y') {
                 appendChatroomInfo(usr + ' accepted your invitation.');
             } 
             else if (msg == 'N') {
                 appendChatroomInfo(usr + ' rejected your invitation.');
             } 
             else if (msg == 'L') {
                 appendChatroomInfo(usr + ' will accept your invitation later.');
             }
             else {
                 appendChatroomInfo('Unknown invitation reply code: ' + 
                                    msg + ' from ' + usr);
             }
         }
         function handle_c_event(jo) {
             var type = jo.type;
             var usr = jo.usr;
             var tracker = jo.tracker;
             //dump(':event: ' + type + ',' + usr + ',' + tracker);
             
             if (type == 'join_room') {
                 if (current_room != '') {
                     msg = 'User "' + usr + '" entered room.';
                     appendChatroomInfo(msg);
                     appendToSelectList('selectRoomUsersList', usr);
                 }
             }
             else if (type == 'leave_room') {
                 if (current_room != '') {
                     msg = 'User "' + usr + '" left room.';
                     appendChatroomInfo(msg);
                     removeFromSelectList('selectRoomUsersList', usr);
                 }
             }
             else if (type == 'room_created') {
                 var v = usr.split(':');
                 if (v.length == 2 && v[1] != '') {
                     var room_name = v[1];
                     addRoomsList(room_name);
                     $('#span_msg').html('New room ' + room_name + ' is created.');
                     $('#span_msg').show().delay(5000).fadeOut();
                 }
                 else if (DEBUG) {
                     dump('Event room_created wrong parameter (no room): ' + usr);
                 }
             }
             else if (type == 'room_gone') {
                 var v = usr.split(':');
                 if (v.length == 2 && v[1] != '') {
                     var room_name = v[1];
                     removeFromSelectList('selectRoomsList', room_name);
                     $('#span_msg').html('Room ' + room_name + ' is gone.');
                     $('#span_msg').show().delay(5000).fadeOut();
                 }
                 else if (DEBUG) {
                     dump('Event room_created wrong parameter (no room): ' + usr);
                 }
             }
             else if (type == 'login') {
                 appendToSelectList('selectUsersList', usr);
                 $('#span_msg').html('User ' + usr + ' logs in.');
                 $('#span_msg').show().delay(5000).fadeOut();
             }
             else if (type == 'logout') {
                 removeUsersList(usr);
                 removeFromSelectList('selectRoomUsersList', usr);
                 var action = (tracker == '' ? ' is disconnected.' : ' logs out.');
                 $('#span_msg').html('User ' + usr + action);
                 $('#span_msg').show().delay(5000).fadeOut();
             }

         }

         function addRoomsList(room_name) {
             appendToSelectList('selectRoomsList', room_name);
             if (room_name == current_room) {
                 setSelectOptionBgColor('selectRoomsList', room_name, '#ccddff');
             }
         }

         function removeUsersList(user_name) {
             $('#selectUsersList option[value=' + user_name + ']').remove();
         }

         function dump(msg) {
             appendConsole(msg);
         }

         function make_tracker() {
             // create a random number as tracker.
             return Math.floor((Math.random() * 1000000) + 1);
         }

         /* handle response messages. */
         function handle_cr_register(status, msg, tracker) {
             if (current_cmd != "register" || current_tid != tracker) {
                 dump('false register response. abort');
                 dump('cur_cmd = ' + current_cmd + ', cur_tid = ' + current_tid);
                 return;
             }
             if (status == 'ok') {
                 //document.getElementById('span_action').style.display = 'none';
                 document.getElementById('reg_pwd').value = ''; // clear password.
                 updateInfo("You are registered. Now you can log in.");
                 cancelFormReg();
             } else {
                 updateInfo('Register failed: ' + msg + '.', 'error');
                 document.getElementById('reg_name').focus();
             }
         }
         function handle_cr_login(status, msg, tracker) {
             //alert('get in. status = ' + status);
             if (current_cmd != "login" || current_tid != tracker) {
                 dump('false login response. abort.');
                 //dump('cur_cmd = ' + current_cmd + ', cur_tid = ' + current_tid);
                 return;
             }
             if (status == 'ok') {
                 document.getElementById('span_action').style.display = 'none';
                 document.getElementById('login_pwd').value = ''; // clear password.
                 //updateInfo("You are logged in. <a href='#' onclick='doLogout();'>Log out</a>");

                 // msg is username plus sequence number when the user 
                 // logs in with multple sessions.
                 current_user = msg;  // $('#login_name').val();
                 var msg_logout = ' [<a href="#" onclick="doLogout();">Logout</a>] ';
                 $('#div_logout').html(msg_logout);

                 $('#div_user').html('User: ' + current_user);

                 client_get_room_list();
                 client_get_user_list();

                 // enable chatroom once logged in, so user can
                 // use command interface too, instead of must use 
                 // GUI for create/join room.
                 disableChatroom(false); 
                 appendChatroomInfo('You are logged in.');
                 appendChatroomInfo('Type @rooms for room list, @create {room} to create room, @join {room} to join a room, @help for more.');
             } else {
                 updateInfo('Invalid login name or password.', 'error');
                 document.getElementById('login_name').focus();
             }
         }
         function handle_cr_update_pwd(status, msg, tracker) {

         }
         function handle_cr_update_pwd2(status, msg, tracker) {
             if (status != 'ok') {
                 appendChatroomInfo('Error: ' + msg);
                 return;
             }

             appendChatroomInfo(msg);
         }

         function handle_cr_get_room_list_console(status, msg, tracker) {
             if (status != 'ok') {
                 updateInfo(msg, 'error');
                 return;
             }

             msg = msg.split(',').sort().join(', ');
             appendChatroomInfo("@rooms: " + msg);
         }
         function handle_cr_get_room_list(status, msg, tracker) {
             if (request_src == 'console') {
                 handle_cr_get_room_list_console(status, msg, tracker);
                 request_src = '';
                 return;
             }

             //appendConsole('now populate room list: ' + msg);
             if (status == 'ok') {
                 // add to selectRoomsList
                 addToSelectList('selectRoomsList', '', msg);
                 setSelectOptionBgColor('selectRoomsList', current_room, '#ccddff');
             }
             else {
                 updateInfo('Error when get room list:' + msg + '.', 'error');
             }
         }

         function addToSelectList(listName, empty_option, listItems) {
             var o = $('#' + listName);

             // clear all entries and insert empty option if any.
             o.children().remove();

             if (empty_option != '') {
                 o.append($('<option>', {
                     value: '',
                     text: empty_option
                 }));
             }

             if (listItems != '') {
                 var items = listItems.split(',').sort();
                 items.forEach(function(item_name) {
                     o.append($('<option>', {
                         value: item_name,
                         text: item_name
                     }));
                 });
             }
         }
         function appendToSelectList(listName, item_name) {
             var o = $('#' + listName);
             o.append($('<option>', {
                 value: item_name,
                 text: item_name
             }));
         }
         function removeFromSelectList(listName, item_name) {
             $('#' + listName + ' option[value=' + item_name + ']').remove();
         }
         function setSelectOptionBgColor(listName, item_name, color) {
             if (color == '') { color = 'transparent'; }

             $('#' + listName + ' option[value=' + item_name + ']').css(
                 'background-color', color
             );
         }

         function handle_cr_get_user_list_console(status, msg, tracker) {
             if (status != 'ok') {
                 updateInfo(msg, 'error');
                 return;
             }
            
             msg = msg.split(',').sort().join(', ');
             appendChatroomInfo("@users: " + msg);
         }
         function handle_cr_get_user_list(status, msg, tracker) {
             if (request_src == 'console') {
                 handle_cr_get_user_list_console(status, msg, tracker);
                 request_src = '';
                 return;
             }

             //appendConsole('now populate user list: ' + msg);
             if (status == 'ok') {
                 // add to selectUsersList
                 addToSelectList('selectUsersList', '', msg);
             }
             else {
                 updateInfo('Error when get user list:' + msg + '.', 'error');
             }
         }

         function handle_cr_get_room_user_list(status, msg, tracker) {
             if (status != 'ok') {
                 updateInfo(msg, 'error');
                 return;
             }

             var v = msg.split(':');
             var room_name = v[0];
             var users = v[1].split(',').sort().join(', ');

             if (request_src == 'console_who') {
                 appendChatroomInfo("@who: current room users: " + users);
             }
             else if (request_src == 'showRoomUsers') {
                 addToSelectList('selectRoomUsersList', '', v[1]);
             }
             else {
                 appendChatroomInfo("room '" + room_name + "' users: " + users);
             }
             request_src = '';
         }
         function handle_cr_create_room(status, msg, tracker) {
             request_src = '';
             if (status != 'ok') {
                 updateInfo(msg, 'error');
                 appendChatroomInfo(msg);
                 return;
             }

             var v = msg.split(':');
             //appendConsole("handle create room: " + v[0] + ", " + v[1]);
             var room_name = v[1];

             $('#spanCreateRoom').hide();

             if (current_room != '') {
                 appendChatroomInfo('You left room ' + current_room);
                 // clear background color of previous current_room.
                 setSelectOptionBgColor('selectRoomsList', current_room, '');
             }
             current_room = room_name;
             //disableChatroom(false);
            
             $('#div_room').html('Room: ' + room_name);
             appendChatroomInfo('You created and entered room ' + room_name + '.');
             appendConsole('You created and joined room: ' + room_name);

             showRoomUsers(room_name);
         }
         function handle_cr_invite(status, msg, tracker) {
             if (status != 'ok') {
                 appendChatroomInfo(msg);
                 return;
             }
             var v = msg.split(':');
             if (v.length < 2) {
                 updateInfo('invalid invite msg: ' + msg, 'error');
                 appendChatroom('Error happened when invite user to join.');
                 return;
             }

             var invitee = v[0];
             appendChatroomInfo('You invited ' + invitee + ' to join.');
         }
         function handle_cr_invite_reply(status, msg, tracker) {
             if (status != 'ok') {
                 appendChatroomInfo(msg);
                 return;
             }
             var v = msg.split(':');
             if (v.length < 3) {
                 updateInfo('invalid invite msg: ' + msg, 'error');
                 //appendChatroom('invalid invite reply message.');
                 return;
             }

             var inviter = v[0];
             var room = v[1];
             var reply = v[2];

             if (reply == 'Y') {
                 msg = 'You accepted invitation of ' + 
                       inviter +' to join room ' + room + '.';
             }
             else if (reply == 'N') {
                 msg = 'You rejected invitation of ' + 
                       inviter +' to join room ' + room + '.';
             }
             else if (reply == 'L') {
                 msg = 'You will accept invitation of ' + 
                       inviter +' to join room ' + room + ' later.';
             } else {
                 msg = 'invalid invite reply message.';
             }
             appendChatroomInfo(msg);

             if (reply == 'Y') {
                 doJoinRoom(room);
             }
         }

         function handle_cr_join_room(status, msg, tracker) {
             if (status != 'ok') {
                 //updateInfo(msg, 'error');
                 appendChatroomInfo(msg);
                 return;
             }
             if (tracker != current_tid) {
                 if (DEBUG) {
                     msg = 'join room message with wrong tracker.';
                     updateInfo(msg, 'error');
                     appendChatroomInfo('Error: ' + msg);
                 }
                 return;
             }

             var v = msg.split(':');
             if (v.length < 2 || v[1] == '') {
                 updateInfo("join_room: invalid room name.");
                 return;
             }
             var room_name = v[1];

             $('#spanCreateRoom').hide();

             if (current_room != '') {
                 setSelectOptionBgColor('selectRoomsList', current_room, '');
             }
             current_room = room_name;
             setSelectOptionBgColor('selectRoomsList', room_name, '#ccddff');
             //disableChatroom(false);

             $('#div_room').html('Room: ' + room_name);
             appendChatroomInfo('You entered room ' + room_name + '.');
             appendConsole('You joined room: ' + room_name);

             showRoomUsers(room_name);
         }
         function handle_cr_leave_room(status, msg, tracker) {
             if (status != 'ok') {
                 appendChatroomInfo(msg);
                 return;
             }
             if (tracker != current_tid) {
                 if (DEBUG) {
                     msg = 'leave room message with wrong tracker.';
                     appendConsole(msg, 'error');
                 }
                 appendChatroomInfo(msg);
                 return;
             }

             $('#div_room').html('Room: ');
             appendChatroomInfo('You left room ' + current_room + '.');

             $('#spanCreateRoom').show();

             setSelectOptionBgColor('selectRoomsList', current_room, '');
             hideRoomUsers();

             current_room = '';
             //disableChatroom(true);
         }
         function handle_cr_speak(status, msg, tracker) {
             if (status != 'ok') {
                 //updateInfo(msg, 'error');
                 appendChatroom('<font color="red">Error sending message (tracker: ' 
                                + tracker + '): ' + msg + '</font>');
                 return;
             }
             if (tracker != current_tid) {
                 if (DEUBG) {
                     msg = 'speak message with wrong tracker.';
                     //appendChatroom('<font color="red">Wrong tracker ' 
                     //               + tracker + ': ' + msg + '</font>');
                     // Note this is possible when the user speaks too fast that
                     // he sends a msg before response of the first msg comes back.
                     return;
                 }
                 return;
             }
         }
         function handle_cr_whisper(status, msg, tracker) {

         }
         function handle_cr_broadcast(status, msg, tracker) {

         }
         function handle_cr_admin_show_table(status, msg, tracker) {

         }
         function handle_cr_logout(status, msg, tracker) {
             if (status == 'ok') {
                 $('#div_logout').html('');
                 updateInfo('You are logged out.', 'info');
                 document.getElementById('span_action').style.display = 'block';
                 cleanup_logout();
             }
             else {
                 updateInfo(msg);
                 cleanup_logout(); // should do cleanup no matter what.
             }
         }
         function cleanup_logout() {
             // clean up the select room list.
             $('#selectRoomsList').children().remove();
             $('#selectUsersList').children().remove();

             showAllUsersPanel();
             $('#selectRoomUsersList').children().remove();
             $('#span_room_users').hide();

             $('#spanCreateRoom').show();
             current_user = '';
             current_room = '';
             disableChatroom(true);

             $('#div_logout').html('');
             $('#div_user').html('User: ');
             $('#div_room').html('Room: ');
             updateInfo('');
         }

         function client_get_room_list() {
             var tracker = make_tracker();
             var msg = '{"cmd":"get_room_list", "tracker":"' + tracker + '"}';
             send_data(msg);
         }
         function client_get_user_list() {
             var tracker = make_tracker();
             var msg = '{"cmd":"get_user_list", "tracker":"' + tracker + '"}';
             send_data(msg);
         }

         function showAllUsersPanel() {
             $('#selectUsersList').show();
             $('#selectRoomUsersList').hide();

             $('#span_all_users').css('background-color', '#ccddff');
             $('#span_room_users').css('background-color', '#99bbff');

             $('#span_all_users').css('color', 'black');
             $('#span_room_users').css('color', '#eeeeff');
         }

         function showRoomUsersPanel() {
             $('#selectUsersList').hide();
             $('#selectRoomUsersList').show();

             $('#span_all_users').css('background-color', '#99bbff');
             $('#span_room_users').css('background-color', '#ccddff');

             $('#span_all_users').css('color', '#eeeeff');
             $('#span_room_users').css('color', 'black');
         }

         function showRoomUsers(room_name) {
             $('#span_room_users').show();
             showRoomUsersPanel();

             request_src = "showRoomUsers";
             current_cmd = "get_room_user_list";
             data = '{"cmd":"get_room_user_list", "room_name":"' + 
                    room_name + '", "tracker":"' + current_tid + '"}';
             send_data(data);
         }

         function hideRoomUsers() {
             $('#span_room_users').hide();
             showAllUsersPanel();
         }

         $(document).ready(function() {
             $('#txtNewRoom').keyup(function (e) {
                 if(e.which === 13) {
                     doCreateRoom( $(this).val() );
                 }
             });

             $('#btnClearConsole').click(function() {
                 $('#console').html('');
             });

             getInputFocus();

             if (DEBUG) {
                 $('#debug_console').show();
             }

             $('#cbToggleDebug').click(function() {
                 if ($(this).attr('checked')) { 
                     $('#btnClearConsole').show();
                     $('#console').show();
                 } else {
                     $('#btnClearConsole').hide();
                     $('#console').hide();
                 }
             });

             /*$('#selectRoomsList').click(function() {
                 doGetRoomUsers();
             });*/

             $('#selectRoomsList').dblclick(function () {
                 $("#selectRoomsList option:selected").each(function () {
                     //alert('hi: ' + $(this).val());
                     if ($(this).val() == current_room) {
                         appendChatroomInfo('You are already in room ' + current_room);
                     } else {
                         doJoinRoom($(this).val());
                     }
                 });
             });

             /*
             $("#selectRoomsList").change(function () {
                $("option", $(this)).each(function (index) {
                    if ($(this).is(":selected")) {
                        $(this).css("backgroundColor", "#99ffcc");
                    }
                    else {
                        $(this).css("backgroundColor", "white");
                    }
                });
             });
             */

             $('#selectRoomsList').blur(function() {
                 // de-select all rows.
                 document.getElementById('selectRoomsList').selectedIndex = -1;
             });
 
             $('#selectUsersList').blur(function() {
                 // de-select all rows.
                 document.getElementById('selectUsersList').selectedIndex = -1;
             });

             $('#span_all_users').click(function() {
                 showAllUsersPanel();
             });

             $('#span_room_users').click(function() {
                 showRoomUsersPanel();
             });

             doDisconnect(true); // initialize to clean state.
             if (AUTO_CONNECT != '') {
                 $('#div_server').hide();
                 current_cmd = 'doConnect';
                 doConnect();
             }
         });
      </script>

      <style type="text/css">
      #container {
          position: relative;
      }
      #chatroom_container {
        position: absolute;
        float: left;
/*display:none;*/

        background-color: #bbccee;
        padding: 5px;
        width: 724px;
        -webkit-border-radius:5px;
        -moz-border-radius:5px;
        border-radius:5px;
      }
      #chatroom {
        height: 450px;
        width: 720px;
        padding: 2px;
        /*background-color: #eeeeff;*/
        color: white;
        background-color: black;
        overflow:auto;
        overflow-y: scroll;
        position: relative;
        bottom: 0;
      }
      #console {
        height: 180px;
        width: 720px;
        background-color: #eeeeff;
        overflow:auto;
        overflow-y: scroll;
        position: relative;
        bottom: 0;
      }
      #div_status {
        width:722px; 
        line-height:25px; 
        height:25px; 
        position: relative; 
        background-color:#eeeeee; 
        border: solid 1px #dddddd;
      }
      #div_user {
        position: absolute;
        overflow:hidden;
        white-space: nowrap;
        float:left; 
        line-height:25px;
        padding-left: 5px;
        padding-right:5px;
        height:23px;
        width:110px;
        color:#666;
        border: solid 1px #cccccc;
      }
      #div_room {
        position: absolute; 
        left: 120px;
        overflow:hidden; 
        white-space: nowrap; 
        float:left; 
        line-height:25px; 
        padding-left: 5px;
        padding-right:5px; 
        height:23px; 
        width:140px; 
        color:#666; 
        border: solid 1px #cccccc;
      }
      #div_msg {
        position: absolute; 
        padding-left:5px; 
        left:272px; 
        width:445px; 
        height:23px; 
        border: solid 1px #cccccc;
        color: orange;
      }
      #span_invite {
          background-color: #ccffcc;
          border: solid 1px #99cc99;
          position: absolute;
          top: 130px;
          left: 150px;
          padding: 5px;
      }


      #div_right_panel {
          float: left;
          position: absolute;
          left: 740px;
          width: 201px;
          height: 490px;
          background-color: #bbccff;
          padding-left: 2px;
          padding-right: 2px;

          -webkit-border-radius:5px;
          -moz-border-radius:5px;
          border-radius:5px;
      }

      #div_RoomsList {
          top: 0px;
          left: 740px;
          width: 200px;
          height: 200px;
          padding: 0px;
      }
      #selectRoomsList {
          float: left;
          top: 0px;
          left: 740px;
          width: 200px;
          height: 180px;
          padding: 3px;

          /*border:0px;
          outline:0px;*/

          -webkit-border-radius:5px;
          -moz-border-radius:5px;
          border-radius:5px;
      }
      #selectRoomsList option {
          background-image:url(images/home.png);
          background-size: 15px 15px;
          background-repeat: no-repeat;
          padding-left: 20px;
      }

      #div_UsersList {
          top: 200px;
          left: 740px;
          width: 200px;
          height: 270px;
          padding: 0px;
      }
      #selectUsersList {
          top: 200px;
          left: 740px;
          width: 200px;
          height: 265px;
          padding: 3px;

          /*border:0px;
          outline:0px;*/

          -webkit-border-radius:5px;
          -moz-border-radius:5px;
          border-radius:5px;
      }
      #selectUsersList option {
          background-image:url(images/icon-person.png);
          background-size: 15px 15px;
          background-repeat: no-repeat;
          padding-left: 20px;
      }

      #selectRoomUsersList {
          display:none;
          top: 200px;
          left: 740px;
          width: 200px;
          height: 265px;
          padding: 3px;

          /*border:0px;
          outline:0px;*/

          -webkit-border-radius:5px;
          -moz-border-radius:5px;
          border-radius:5px;
      }
      #selectRoomUsersList option {
          background-image:url(images/icon-person.png);
          background-size: 15px 15px;
          background-repeat: no-repeat;
          padding-left: 20px;
      }

      .span_placeholder {
          width: 1px;
          display: inline-block;
      }
      .div_title {
          -webkit-border-top-left-radius: 5px;
          -webkit-border-top-right-radius: 5px;
          -moz-border-radius-topleft: 5px;
          -moz-border-radius-topright: 5px;
          border-top-left-radius: 5px;
          border-top-right-radius: 5px;

          text-align: center;
          display: inline-block;
          padding-left: 5px;
          padding-right: 5px;
          background-color: #99bbff;
          color: #eeeeff;

          box-shadow: 6px 0 4px  -4px #222 , -6px 0 4px  -4px #222;   
          -moz-box-shadow: 6px 0 4px  -4px #222, -6px 0 4px  -4px #222;   
          -webkit-box-shadow: 6px 0 4px  -4px #222, -6px 0 4px  -4px #222;   
      }


      option:nth-child(odd) { background: white; }
      option:nth-child(even) { background: #eeeeee; }

      #debug_console {
          /* clear: both; */
          position: absolute;
          top: 700px;
      }
      </style>
   </head>
   <body>
      <h1>Websocket Chatroom</h1>

      <span id='div_server'>
      Server: ws://<input type="text" id="ws" value="127.0.0.1:9000"/>
      <input type='button' id='btnConnect' onclick='btnConnect_onclick(this);' value='Connect'></input>
      </span>

      <span id='connection_status'></span>&nbsp;&nbsp;
      <span id='div_logout'></span>
      <span id="div_info"></span>
      <br/><br/>

      <span id='span_action' style='display:none;'>
      <span id='form_reg' style='display:none;'>
      name: <input type='txt' id='reg_name'/>
      password: <input type='password' id='reg_pwd'/>
      <input type='button' value='Register' onclick='doRegister();'></input>
      &nbsp;&nbsp;<a href='#' onclick="cancelFormReg();">Cancel</a>
      <br/><br/>
      </span>

      <span id='form_login' style='display:inline-block;'>
      name: <input type='txt' id='login_name'/>
      password: <input type='password' id='login_pwd'/>
      <input type='button' value='Login' onclick='doLogin();'></input>
      &nbsp;&nbsp;<a href='#' onclick="showFormReg();">Register</a>
      <br/><br/>
      </span>
      </span>

      <input type="text" id="txtMsg" onkeypress="checkEnter(event);" size="50"/>
      <button style='display:none;' id='btnSendTxt' onclick='sendText();'>Send Text Message</button>
      <button style='display:none;' id='btnSendBin' onclick='sendBinary();'>Send Binary Message</button>
      <button onclick='clearChatroom();' title='Clear chat history'>Clear History</button>
      <button onclick="selectText('chatroom');" title='Select history for copy'>Select History</button>

      <br/><br/>

      <div id="container">

      <div id="chatroom_container">
      <div id="chatroom">
          <span id='span_invite' style='display:none;'>
          <span id='invite_msg'></span>
          <input type='text' id='txtInviteReply' onkeypress="doInviteReply(event, this.value);" style="width: 100px;"/>
          <span id='inviter' style='display:none;'></span>
          <span id='inviter_room' style='display:none;'></span>
          </span>
      </div>

      <div id="div_status">
          <div id='div_user'>User: </div>
          <div id='div_room'>Room: </div>
          <div id='div_msg'>
              <span id='span_msg' style='color: orange;'></span>
          </div>
      </div>
      </div> <!--end of chatroom_container-->

      <div id="div_right_panel">

      <div id="div_RoomsList">
      <span class="span_placeholder"></span>
      <span class="div_title" style="width:50px; color:black; background-color:#ccddff;">Rooms</span>
      <select id='selectRoomsList' size="5" 
              title='Double click to enter a room'>
      </select>
      </div>

      <div id="div_UsersList">
      <span class="span_placeholder"></span>
      <span id="span_all_users" class="div_title" style="width:50px; color:black; background-color:#ccddff;">Users</span>
      <span id="span_room_users" class="div_title" style="width:100px; display:none;">Room users</span>
      <select id='selectUsersList' size="5"></select>
      <select id='selectRoomUsersList' size="5"></select>
      </div>

      </div> <!-- end of div_right_panel -->

      </div><!-- end of container -->

      <div style="clear:both;"></div>

      <div id="debug_console" style="display:none;">
          <input type="checkbox" id="cbToggleDebug" title="Click to toggle debug console"/>
          Debug console: <a href='#' id='btnClearConsole' style="display:none;">Clear console</a><br/>
          <div id="console" style="display:none;"></div>
      </div>

   </body>
</html>
